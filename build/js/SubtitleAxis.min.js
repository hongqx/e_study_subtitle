/*! estudysubtitle version1.1.0  2016-11-02  06:44:54*/
define(["peaks"],function(a){var b={};window.segmentPart=b,b.init=function(c,d){this.segments=[],this.peaksInstance=a.init(c),this.segsNum=c.segments.length,this.peaksInstance.zoom.zoomOut();var e=b;this.peaksInstance.on("segments.dragend",function(a){e.updateSegment(a)}),this.peaksInstance.on("segments.dragstart",function(a){e.dragStartCallBack(a)}),this.peaksInstance.on("segment.click",function(a){e.changeSegment(a)}),this.peaksInstance.on("segments.ready",function(){f(),e.segsNum>0?(e.curIndex=0,e.ifBlank=!0):(e.curIndex=-1,e.ifBlank=!1),e.segments=e.getSegments()||[],e.time(0)}),this.peaksInstance.on("user_seek.zoomview",function(a){e.userSeek(a)}),this.peaksInstance.on("player_time_update",function(a){e.timeUpdate(a)})},b.getIndexByCurrentTime=function(a){var b=a?a:this.peaksInstance.time.getCurrentTime(),c=this.peaksInstance.segments.getSegments(),d=0,e=c.length;if(0===e||b>c[e-1].endTime)return-1;for(;d<e-1;){if(b>=c[d].startTime&&b<=c[d].endTime)return d;if(d+1<e&&b>c[d].endTime&&b<c[d+1].startTime)return-1;d++}return-1},b.userSeek=function(a){if(!(this.segments.length<1)){if(this.curIndex>-1){var b=this.segments[this.curIndex];if(a>=b.startTime&&a<=b.endTime)return}var c=this.getIndexByCurrentTime(a);c>-1?(this.curIndex=c,this.ifBlank=!1,this.startTime=this.segments[this.curIndex].startTime,this.endTime=this.segments[this.curIndex].endTime):(this.ifBlank=!0,this.startTime=-1,this.endTime=-1,clearInterval(this.interval),this.interval=null,this.peaksInstance.segments.changeCurrentMarker(this.curIndex),Control.subtitleAxis.changeCurrentIndex(-1,!0))}},b.timeUpdate=function(a){if(!(this.segments.length<1)){if(this.endTime>0&&Math.abs(a-this.endTime)<.05&&!this.ifBlank)return this.peaksInstance.player.pause(),this.time(this.endTime),clearInterval(this.interval),void(this.interval=null);var b=this.segments[this.curIndex];if(b&&a>=b.startTime&&a<=b.endTime)return this.ifBlank=!1,void(this.curIndex!==Control.subtitleAxis.curIndex&&Control.subtitleAxis.changeCurrentIndex(this.curIndex,!0));var c;this.curIndex+1<this.segments.length&&(c=this.segments[this.curIndex+1]),c&&a>=c.startTime&&a<=c.endTime?(this.curIndex++,this.ifBlank=!1,Control.subtitleAxis.changeCurrentIndex(this.curIndex,!0)):(this.ifBlank=!0,Control.subtitleAxis.changeCurrentIndex(-1,!0),this.startTime=-1,this.endTime=-1)}},b.changeSegment=function(a){this.curIndex=a.index,this.peaksInstance.player.pause(),this.time(a.startTime),this.endTime=a.endTime,this.startTime=a.startTime,Control.subtitleAxis.changeCurrentIndex(this.curIndex,!0),this.ifBlank=!1},b.getSegmentIndex=function(){var a=Number(this.peaksInstance.time.getCurrentTime().toFixed(2)),b=this.peaksInstance.segments.getSegments(),c=0,d=b.length,e={};if(0===d)return e.startTime=a<1?0:a,e.endTime=e.startTime+1,e.index=0,e;if(a<b[0].startTime)return b[0].startTime<1?0:(a<1?e.startTime=0:b[0].startTime-a>=1?e.startTime=a:e.startTime=a-1,e.endTime=e.startTime+1,e.index=0,e);if(a>b[d-1].endTime){var f=this.peaksInstance.time.getDuration(),g=b[d-1].endTime;return f-g<1?0:f===g?1:(e.startTime=f-a<1||a-g<1?g:a,e.endTime=e.startTime+1,e.index=d,e)}for(var h=-1;c<d;){if(a>b[c].startTime&&a<b[c].endTime)return 1;if(a>b[c].endTime&&a<b[c+1].startTime){h=c;break}c++}if(h<0)return 1;var g=b[h].endTime;return b[h+1].startTime-g===0?1:b[h+1].startTime-g<1?0:(e.startTime=a-b<1||b[h+1].startTime-a<1?g:a,e.endTime=e.startTime+1,e.index=h,e)},b.addSegment=function(a,b){var a=this.getSegmentIndex();if(0===a)e("当期位置时间空隙不够，无法添加，请删除相邻时间轴之后再添加!",!0);else{if(1===a)return void e("当期位置已有时间轴，无法添加!",!0);a.editable=!0,a.index%2===0?a.color="#646464":a.color="#343434",a.segmentId=b?b:"b_"+(new Date).getTime();var a=this.peaksInstance.segments.add([a]);a&&a.length>0?(this.segments=this.peaksInstance.segments.getSegments(),this.segsNum=this.segments.length,this.curIndex=a[0].index,this.ifBlank=!1,this.startTime=a[0].startTime,this.endTime=a[0].endTime,this.time(this.startTime),Control.subtitleAxis.addSubtitle(a)):e("时间轴添加失败，请重试!!",!0)}},b.getSegments=function(){return this.peaksInstance.segments.getSegments()},b.updateSegment=function(a){a.length<1||(this.startTime=a.startTime,this.endTime=a.endTime,Control.subtitleAxis.updateSubtitle(a),this.getSegments())},b.deleteSegment=function(a,b){var c,d;if(b)c=b;else if(a||0===a)d=a;else if(d=this.getIndexByCurrentTime(),d===-1)return e("当期位置没有可删除的时间轴",!0),!1;var c=c?c:this.peaksInstance.segments.getSegments()[d],f=c.startTime,g=c.endTime,h=this.peaksInstance.segments.removeByTime(f,g);return h>0?(this.segments=this.peaksInstance.segments.getSegments(),this.segsNum=this.segments.length,this.curIndex=-1,this.ifBlank=!0,this.startTime=-1,this.endTime=-1,!0):(e("删除时间轴失败，请重试！",!0),!1)},b.time=function(a,b){return a&&this.peaksInstance.time.setCurrentTime(a),b&&(this.curIndex=b),this.peaksInstance.time.getCurrentTime()},b.setPlayTime=function(a,c){a<0&&c<0||(this.time(this.startTime),this.peaksInstance.player.play(),this.interval||(this.interval=setInterval(function(){var a=b.time();b.timeUpdate(a)},50)))},b.dragStartCallBack=function(a){c.play(!0)},b.changeMarker=function(a){if(a>-1&&a<this.segments.length){var b=this.segments[a];this.peaksInstance.segments.changeCurrentMarker(b),this.peaksInstance.player.pause(),this.time(b.startTime),this.endTime=b.endTime,this.startTime=b.startTime,this.curIndex=a,this.ifBlank=!1}};var c={};window.subtitleAxis=c,c.urls={updateS:"​http://m.yxgapp.com/d/mooc/UpdateSubtitleAxis.json",update:"​http://m.yxgapp.com/d/mooc/UpdateSubtitle.json",doload:"http://m.yxgapp.com/mooc/{@videoId}/DownloadSubtitle.json",getState:"http://m.yxgapp.com/mooc/GetStaticSubtitleState.json"};var d=['<li class="{@class}" id="{@textId}" data-index={@data-index} data-id={@textId}>','<div class="subtitle">','<div class="subspan">','<span class="start-time">{@startTime}</span>',"</div>",'<div class="sub-content" data-index={@data-index}>','<textarea data-index="{@data-index}" name="" cols="30" rows="10" placeholder="edit...">{@content}</textarea>','<div class="txt">{@content}</div>',"</div>",'<div class="subspan">','<span class="js_wps">{@wps}</span>','<span class="js_alltime">{@alltime}seconds</span>','<span class="js_wordsCount">{@word}word</span>','<span class="delete-icon" data-id={@textId}>——</span>',"</div>","</div>",'<div class="buttomline"></div>',"</li>"].join(""),e=function(a,b){$("#js_mask").show(),a&&$("#js_note .layui-layer-content").html(a),$("#js_note .layui-layer-btn").hide(),$("#js_note").show(),b&&setTimeout(function(){$("#js_mask").hide(),$("#js_note").hide()},500)},f=function(){$("#js_mask").hide(),$("#js_note").hide()},g=function(a,b,d,e,f){var g=1==f?"POST":"GET",h=c;$.ajax({url:a,data:b,type:g,dataType:"json",success:function(c){console.log("getData success | "+a+" | "+b),d?"string"==typeof d?h[d](c):"function"==typeof d&&d(c):console.log(c)},error:function(c){console.error("getData error | "+a+" | "+b),e?"string"==typeof e?h[e](c):"function"==typeof e&&e(c):console.log(c)}})};return c.init=function(a,b){return this.options=a,this.containerId=b,this.container=$("#"+b),this.checkIfDatData(),this.localKey=this.options.videoId+"_SUBTITLEAXIS",this.remainKey="REMAIN_SUBTITL",this.remainSKey="REMAIN_SUBTITLEAXIS",this.baseLanguage=a.language,this.newSegments=[],this.newSubtitles=[],this},c.checkIfDatData=function(){var a="http://alicdnsub.yxgapp.com/waveMap/"+this.options.videoId+".dat",b=this;g(a,{},function(a){return 404===a.status||503===a.status?(console.error("video dat 是error"),void e("抱歉，当前视频暂不支持制作字幕，请通过app告诉我们，谢谢！")):void b.getServerSubTitles()},function(a){404===a.status||503===a.status?(console.error("video dat 是error"),e("抱歉，当前视频暂不支持制作字幕，请通过app告诉我们，谢谢！")):b.getServerSubTitles()})},c.getServerSubTitles=function(){var a=LocalStorage.getItem(this.localKey);try{a=JSON.parse(a)}catch(b){console.error("本地存储数据解析失败||"+a),this.staticState=!0}if(!a||this.staticState){var c=({videoId:this.options.videoId,userName:this.options.userName,token:this.options.token},this.urls.doload);c=c.replace("{@videoId}",this.options.videoId),g(c,{},"downLoadSubTitlesCallBack")}else this.localSubtitles=a,this.getStaticState()},c.downLoadSubTitlesCallBack=function(a){var b=null;a.result&&a.subtitle&&(b=a.subtitle),b.subtitleItems.length>0&&(b.subtitleItems=this.sort(b.subtitleItems));var c=this.dealLoadSubTitle(b);this.localSubtitles?this.mergeLocalItems(c):this.subtitles=c,this.startInitContent()},c.startInitContent=function(){if(this.segmentPart(),this.initDom(),this.subtitles.subtitleItems.length>0){var a=this.subtitles.subtitleItems[this.curIndex];this.changeCurrentTime(a.startTime/1e3,a.endTime/1e3)}this.addEvent(),this.addKeyDownEvent(),this.startPostInterval()},c.getStaticState=function(){var a={videoId:this.options.videoId,userName:this.options.userName,token:this.options.token};g(this.urls.getState,a,"staticStateCallBack","staticStateError")},c.staticStateCallBack=function(a,b){"error"===b?(this.staticState=!0,this.getServerSubTitles()):a.result&&!a.result.result?(this.staticState=!0,this.getServerSubTitles()):(this.staitcState=a.subtitleResult,this.staticState?this.getServerSubTitles():(this.mergeLocalItems(),this.startInitContent()))},c.staticStateError=function(){this.staticState=!0,this.getServerSubTitles()},c.sort=function(a){function b(a,b,c){for(var d=c,e=c+1;e<b;++e)parseInt(a[d].startTime)>parseInt(a[e].startTime)&&(d=e);return d}var c=0,d=a.length;for(c;c<d;c++){var e=b(a,d,c);if(e!==c){console.log("min:"+e+"  i"+c);var f=a[c];a[c]=a[e],a[e]=f}}return a},c.dealLoadSubTitle=function(a){var b={};if(this.segments=[],a){b.timeStamp=a.subtitleTimestamp,b.baseLanguage=this.baseLanguage,b.subtitleItems=[];for(var c=0,d=a.subtitleItems.length;c<d;c++){var e=a.subtitleItems[c],f=0,g=e.data.length,h={};h.startTime=e.startTime<0?0:parseInt(e.startTime)/1e3,h.endTime=parseInt(e.endTime)/1e3,h.editable=!0,h.id=e.id,h.segmentId=e.id,h.overview="Kinetic.Group",h.zoom="Kinetic.Group";var i={};if(i.startTime=parseInt(e.startTime),i.endTime=parseInt(e.endTime),i.id=e.id,i.subtitleItemId=e.id,i.isDifficult=3,0===g)i.content="",i.language=this.baseLanguage;else for(;f<g;f++)e.data[f].language!==this.baseLanguage||(i.content=e.data[f].content?e.data[f].content:"",i.explanation=e.data[f].explanation,i.updateTime=e.data[f].updateTime,i.username=e.data[f].username,i.userNickname=e.data[f].userNickname,i.language=this.baseLanguage,i.subtitleItemId=e.id);b.subtitleItems.push(i),this.segments.push(h)}}else b.timeStamp=Math.ceil((new Date).getTime()/1e3),b.baseLanguage=this.baseLanguage,b.subtitleItems=[];return b},c.mergeLocalItems=function(a){var b=0,c=this.localSubtitles.subtitleItems.length;if(this.segments=[],a){var d=a.subtitleItems.length,c=this.localSubtitles.subtitleItems.length;for(c<d&&a.subtitleTimestamp>this.localSubtitles.subtitleTimestamp&&(c=_nlen);b<c;b++){for(var e=this.localSubtitles.subtitleItems[b],f=0,d=a.subtitleItems.length;f<d;f++){var g=a.subtitleItems[f];if(e.subtitleItemId===g.subtitleItemId||""!==e.content&&e.content===g.content||e.startTime===g.startTime&&e.endTime===g.endTime){e.updateTime<g.updateTime?e=g:e.subtitleItemId.indexOf("b_")>0&&(e.subtitleItemId=g.subtitleItemId);break}}var h={};h.startTime=e.startTime<0?0:e.startTime/1e3,h.endTime=e.endTime/1e3,h.editable=!0,h.id=e.subtitleItemId,h.segmentId=e.subtitleItemId,h.overview="Kinetic.Group",h.zoom="Kinetic.Group",this.segments.push(h)}this.subtitles=this.localSubtitles}else for(;b<c;b++){var h={},g=this.localSubtitles.subtitleItems[b];h.startTime=g.startTime<0?0:g.startTime/1e3,h.endTime=g.endTime/1e3,h.editable=!0,h.id=g.subtitleItemId,h.segmentId=g.subtitleItemId,h.overview="Kinetic.Group",h.zoom="Kinetic.Group",this.segments.push(h)}},c.segmentPart=function(){for(var a=0,c=this.segments.length;a<c;a++)a%2===0?this.segments[a].color="#646464":this.segments[a].color="#343434";var d={container:document.getElementById("peaks-container"),mediaElement:document.querySelector("video"),dataUri:{arraybuffer:"http://alicdnsub.yxgapp.com/waveMap/"+this.options.videoId+".dat"},keyboard:!1,height:150,overviewHighlightRectangleColor:"#0c6d8f",zoomWaveformColor:"#cecece",overviewWaveformColor:"#cecece",playheadColor:"#df1f1e",axisGridlineColor:"#fff",axisLabelColor:"#fff",markerHeight:2,zoomLevels:[512,1024,2048,4096],pointMarkerColor:"#FF0000",inMarkerColor:"#df1f1e",outMarkerColor:"#df1f1e",outlineColor:"#32a0c6",inlineColor:"#35c5f7",randomizeSegmentColor:!1};this.segments.length>0?d.segments=this.segments:d.segments=[],b.init(d)},c.initDom=function(){this.curIndex=0;var a=this.subtitles.subtitleItems,b=0,c=a.length;for(this.liList=[],this.ulDom=0===this.container.find(".sublist").length?$(document.createElement("ul")):$(this.container.find(".sublist")[0]),this.ulDom.css({positon:"relative",top:0,left:0});b<c;b++){var e=a[b],f=((e.endTime-e.startTime)/1e3).toFixed(1),g=b===this.curIndex?"active":"",h=e.content?e.content:"",i=(this.getWordsNum(h)/f).toFixed(1)+"WPS",j=d.replace("{@startTime}",this.getTimeModel(Math.round(e.startTime/1e3))).replace("{@alltime}",f).replace("{@textId}",e.subtitleItemId).replace("{@textId}",e.subtitleItemId).replace("{@textId}",e.subtitleItemId).replace("{@wps}",i).replace("{@word}",this.getWordsNum(h)).replace("{@class}",g).replace("{@content}",h).replace("{@content}",h).replace("{@data-index}",b).replace("{@data-index}",b).replace("{@data-index}",b);$(this.ulDom).append(j)}this.container.append(this.ulDom),this.lis=$(this.container).find("li"),0===c&&($(this.container.find(".sublistnote")).show(),$(this.ulDom).hide());try{$("#"+this.containerId).mCustomScrollbar({theme:"my-theme",mouseWheel:{scrollAmount:131}})}catch(k){var l=this;setTimeout(function(){$("#"+l.containerId).mCustomScrollbar({theme:"my-theme",mouseWheel:{scrollAmount:131}})},500)}},c.addLiDom=function(a,b){0===this.lis.length&&($(this.container.find(".sublistnote")).hide(),$(this.ulDom).show());var c=((b.endTime-b.startTime)/1e3).toFixed(1),e=(b.content.length/c).toFixed(1)+"WPS",f="active",g=d.replace("{@startTime}",this.getTimeModel(Math.round(b.startTime/1e3))).replace("{@alltime}",c).replace("{@textId}",b.subtitleItemId).replace("{@textId}",b.subtitleItemId).replace("{@textId}",b.subtitleItemId).replace("{@wps}",e).replace("{@word}",0).replace("{@class}",f).replace("{@content}",b.content).replace("{@content}",b.content).replace("{@data-index}",a).replace("{@data-index}",a).replace("{@data-index}",a),h=$(g);if(console.log(h),0===this.lis.length)$(this.ulDom).append(h);else if(a>0){var i=$(this.lis[a-1]);h.insertAfter(i)}else if(0===a){var j=$(this.lis[a]);h.insertBefore(j)}this.lis=$(this.container).find("li"),this.updateDomIndex(),this.changeCurrentIndex(a,null,!0)},c.deleteLiDom=function(a,b){var c=$("#"+a);c.remove(),this.lis.splice(b,1),this.curIndex>b&&this.curIndex--,this.lis=$(this.container).find("li"),this.updateDomIndex(),0===this.lis.length&&(console.log(this.container.find(".sublistnote")),$(this.container.find(".sublistnote")).show(),$(this.ulDom).hide())},c.getTimeModel=function(a){var b=a>1e3?parseInt(a/1e3):a,c=parseInt(b/60),d=parseInt(c/60);return c=c>9?c:"0"+c,b%=60,_secondStr=b>9?b:"0"+b,d>0?d+":"+c+":"+_secondStr:c+":"+_secondStr},c.updateDomIndex=function(a){for(var b=0,c=this.lis.length;b<c;b++)$(this.lis[b]).attr("data-index",b),$(this.lis[b]).find(".sub-content").attr("data-index",b),$(this.lis[b]).find("textarea").attr("data-index",b)},c.updateLoacal=function(a){switch(a){case 1:LocalStorage.setItem(this.localKey,JSON.stringify(this.subtitles));break;case 2:var b=LocalStorage.getItem(this.remainKey)?JSON.parse(LocalStorage.getItem(this.remainKey)):[];this.newSubtitles=this.newSubtitles.concat(b),LocalStorage.setItem(this.remainKey,JSON.stringify(this.newSubtitles)),this.newSubtitles=[];break;case 3:var c=LocalStorage.getItem(this.remainSKey)?JSON.parse(LocalStorage.getItem(this.remainSKey)):[];this.newSegments=this.newSegments.concat(c),LocalStorage.setItem(this.remainSKey,JSON.stringify(this.newSegments)),this.newSegments=[]}},c.clearLocal=function(a){switch(a){case 1:LocalStorage.setItem(this.localKey,"");break;case 2:LocalStorage.setItem(this.remainKey,"");break;case 3:LocalStorage.setItem(this.remainSKey,"")}},c.addEvent=function(){var a=this;this.container.delegate(".sub-content","click",function(b){console.log("---sub-content click"),a.subconClick($(this),b,!0)}),this.container.delegate("textarea","blur",function(b){return a.enBlur($(this),b),console.log("textarea blur"),!1}),this.container.delegate(".delete-icon","click",function(b){var c=$(this).attr("data-id"),d=$(this).parent().prev().attr("data-index");a.showDeleteNote(c,parseInt(d),2)}),$("#js_ok").on("click",function(){var b=$("#js_delete"),c=b.attr("data-id"),d=parseInt(b.attr("data-index"));a.deleteSubtitleById(c,d),b.attr("data-index",""),b.attr("data-id",""),b.hide(),$("#js_mask").hide()}),$("#js_cancel").on("click",function(){var a=$("#js_delete");a.attr("data-index",""),a.attr("data-id",""),a.hide(),$("#js_mask").hide()})},c.addKeyDownEvent=function(){var a=this;document.addEventListener("keydown",function(b){var c=b||window.event||arguments.callee.caller.arguments[0];if(c.ctrlKey){var d=c.keyCode;switch(d){case 65:a.addSubtitleAxis();break;case 82:a.playCurrent();break;case 68:a.deleteSubtitleByCurrentTime();break;case 83:a.play();break;default:return!1}}return!1})},c.tabClick=function(a,b){var c=b?this.curIndex+1:this.curIndex-1;return!(c<0||c>=this.subtitles.subtitleItems.length)&&void this.changeCurrentIndex(c,!0)},c.subconClick=function(a,b,c){var d=parseInt(a.attr("data-index"));this.changeCurrentIndex(d,null,c),a.find("textarea").show(),a.find(".txt").hide()},c.enBlur=function(a,b){this.edit=!1,this.editType=null,val=a.val(),a.hide();var c=a.siblings(".txt");c.html(val).show();var d=parseInt(a.attr("data-index")),e=this.subtitles.subtitleItems[d];e.content!==val&&""!==val&&(e.content=val,this.subtitles.timestamp=e.updateTime=parseInt((new Date).getTime()/1e3),e.username=this.options.username,e.userNickname=this.options.nickname,e.isDifficult=3,e.action=0,e.language=this.baseLanguage,e.subtitleItemId=e.subtitleItemId,this.newSubtitles.push(e),this.updateLoacal(1),this.updateWps(a.parent(),d))},c.updateWps=function(a,b){var c=this.subtitles.subtitleItems[b],d=((c.endTime-c.startTime)/1e3).toFixed(1),e=(this.getWordsNum(c.content)/d).toFixed(1)+"WPS",f=$(a).next();f.find(".js_wps").html(e),f.find(".js_wordsCount").html(this.getWordsNum(c.content)+"word")},c.getWordsNum=function(a){a=a.replace(/[\ |\~|\`|\!|\@|\#|\$|\%|\^|\&|\*|||\-|\_|\+|\=|\||\\|||\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?]/g," "),a=a.replace(/(^\s*)/g,"").replace(/(\s*$)/g,"");var b=a.split(" ").length;return b},c.showDeleteNote=function(a,b,c){var d=$("#js_delete"),e=this.subtitles.subtitleItems[b],f=1==c?"时间轴":"字幕";d.find(".layui-layer-content").html("确定要删除开始时间为："+this.getTimeModel(Math.round(e.startTime/1e3))+"的"+f+"?"),d.show(),d.attr("data-index",b),d.attr("data-id",a),$("#js_mask").show()},c.deleteSubtitleById=function(a,c){var d=b.deleteSegment(c);d&&this.removeSubtitle(c)},c.findCurrentIndexByCurrentTime=function(a){var b=a;i=0,_len=this.segments.length;for(var c=null,d=-1;i<_len;i++)if(b>=this.segments[i].startTime&&b<=this.segments[i].endTime){c=this.segments[i],d=i;break}return d},c.deleteSubtitleByCurrentTime=function(){var a=this.findCurrentIndexByCurrentTime(b.time());if(a>=0){var c=this.segments[a].segmentId;this.showDeleteNote(c,a,1)}},c.addSubtitleAxis=function(){b.addSegment()},c.addSubtitle=function(a){var b=(this.segments.length,a[0].index),c=a[0],d={};d.id=c.segmentId,d.action=1,d.startTime=parseInt(1e3*c.startTime),d.endTime=parseInt(1e3*c.endTime),d.source=1,console.log(d),this.segments.splice(b,0,c),this.newSegments.push(d);var e={content:"",endTime:d.endTime,explanation:null,subtitleItemId:d.id,isDifficult:3,language:this.baseLanguage,startTime:d.startTime,updateTime:(new Date).getTime(),userName:this.options.username,userNickname:this.options.nickname};this.subtitles.subtitleItems.splice(b,0,e),this.subtitles.timeStamp=this.subtitles.subtitleItems[b].updateTime=Math.ceil((new Date).getTime()/1e3),this.addLiDom(b,e),this.curIndex=b,console.log("addSubtitle :"+this.curIndex),this.updateLoacal(1)},c.removeSubtitle=function(a){var b=this.subtitles.subtitleItems.splice(a,1)[0];this.segments.splice(a,1)[0];var c={};c.startTime=b.startTime,c.endTime=b.endTime,c.id=b.subtitleItemId,c.action=3,this.subtitles.timeStamp=Math.ceil((new Date).getTime()/1e3),this.newSegments.push(c),this.deleteLiDom(c.id,a),this.updateLoacal(1)},c.updateSubtitle=function(a){var b=$("#"+a.segmentId),c=parseInt(b.attr("data-index"));this.curIndex=c;var d=(this.segments[c],{});_newSubtitle=this.subtitles.subtitleItems[c],this.segments[c].startTime=a.startTime,this.segments[c].endTime=a.endTime,d.startTime=_newSubtitle.startTime=parseInt(1e3*a.startTime),d.endTime=_newSubtitle.endTime=parseInt(1e3*a.endTime),_newSubtitle.updateTime=Math.ceil((new Date).getTime()/1e3),d.id=this.segments[c].segmentId,d.source=1;var e=this.findUpdateItem(2,d);e<0&&(d.action=2,this.newSegments.push(d)),b.find(".start-time").html(this.getTimeModel(Math.round(d.startTime/1e3)));var f=((d.endTime-d.startTime)/1e3).toFixed(1);b.find(".js_alltime").html(f+"seconds");var g=this.subtitles.subtitleItems[c].content||"",h=(this.getWordsNum(g)/f).toFixed(1)+"WPS";b.find(".js_wps").html(h),this.updateLoacal(1)},c.findUpdateItem=function(a,b){var c,d,e;1==a?(c=this.newSubtitles,e="subtitleItemId"):(c=this.newSegments,e="id");for(var d=b[e],f=c.length-1;f>-1;f--)if(d==c[f][e])return f;return-1},c.scrollTo=function(a){var b=0===a?0:150*a;this.container.mCustomScrollbar("scrollTo",b)},c.changeCurrentIndex=function(a,c,d){if(console.log("change currentTime："+a),a===-1){if(this.curIndex>=0){var e=$(this.lis[this.curIndex]);e.removeClass("active"),e.find("textarea").hide(),e.find(".txt").show(),this.curIndex=-1}return void this.showCurVideotext("")}if(a===this.curIndex)return void this.showCurVideotext(this.subtitles.subtitleItems[this.curIndex].content);if(a<0||a>=this.subtitles.subtitleItems.length)return console.log($(this.lis[this.curIndex]).find(".sub-content")[0]),$($(this.lis[this.curIndex]).find(".sub-content")[0]).click(),void this.showCurVideotext("");if(this.curIndex>=0){var e=$(this.lis[this.curIndex]);e.removeClass("active"),e.find("textarea").hide(),e.find(".txt").show()}var f=$(this.lis[a]);f.addClass("active"),f.find("textarea").hide(),f.find(".txt").show(),this.curIndex=a,c&&this.subconClick($(f.find(".sub-content")[0]),null,!0);var g=this.subtitles.subtitleItems[this.curIndex];this.showCurVideotext(g.content),d&&(b.time(g.startTime/1e3,this.curIndex),b.changeMarker(this.curIndex)),this.scrollTo(this.curIndex)},c.startPostInterval=function(){var a=this,b=LocalStorage.getItem(this.remainKey)?JSON.parse(LocalStorage.getItem(this.remainKey)):[],c=LocalStorage.getItem(this.remainSKey)?JSON.parse(LocalStorage.getItem(this.remainSKey)):[];if(b=b.concat(this.newSubtitles),b.length>0){console.log("字幕数据有更新|||||有更新数据，提交"+b.length);var d={token:a.options.token,username:a.options.username,videoId:a.options.videoId,from:3,newSubtitle:JSON.stringify(b)};this.updateLoacal(2),g("http://m.yxgapp.com/d/mooc/UpdateSubtitle.json",d,"sendSubtitleSuccessBack","sendSubtitleErrorBack","POST")}if(c=c.concat(this.newSegments),c.length>0){console.log("时间轴数据有更新|||||有更新数据，提交"+c.length);var d={token:a.options.token,username:a.options.username,videoId:a.options.videoId,from:3,subtitleAxises:JSON.stringify(c)};this.updateLoacal(3),g("http://m.yxgapp.com/d/mooc/UpdateSubtitleAxis.json",d,"sendAxisSuccessBack","sendAxisErrorBack","POST")}if(!this.interval1){var a=this;this.interval1=setInterval(function(){a.startPostInterval()},2e3)}},c.sendSubtitleSuccessBack=function(a){console.log("subtitle success"),a.result.result&&this.clearLocal(2),console.log(a)},c.sendSubtitleErrorBack=function(a){console.error(a)},c.sendAxisSuccessBack=function(a){console.log("Axis-success"),console.log(a),a.result.result&&this.clearLocal(3)},c.sendAxisErrorBack=function(a){console.log("时间轴数据提交失败"+a.result.msg),this.clearLocal(3)},c.saveSegments=function(a,b){},c.changeCurrentTime=function(a,c){b.time(a)},c.playCurrent=function(){var a=this.curIndex;if(console.log("subtitleAxis.playCurrent:"+this.curIndex),a>=0&&!b.ifBlank){var c=this.segments[a].startTime,d=this.segments[a].endTime;b.setPlayTime(c,d)}else b.setPlayTime(-1,-1),this.play()},c.play=function(a){return a?void Control.course.player.pause():void Control.course.player.play()},c.showCurVideotext=function(a){this.videotextDom||(this.videotextDom=$("#js-videotext")),this.videotextDom.html(a)},c});