/*! estudysubtitle version1.1.0 2016-07-20  04:56:34*/
define(["jquery","peaks","segmentPart","mCustomScrollbar"],function(a,b,c,d){var e={};window.subtitleAxis=e,e.urls={updateS:"​http://m.yxgapp.com/d/mooc/UpdateSubtitleAxis.json",update:"​http://m.yxgapp.com/d/mooc/UpdateSubtitle.json",doload:"http://m.yxgapp.com/mooc/{@videoId}/DownloadSubtitle.json",getState:"http://m.yxgapp.com/mooc/GetStaticSubtitleState.json"};var f=['<li class="{@class}" id="{@textId}" data-index={@data-index} data-id={@textId}>','<div class="subtitle">','<div class="subspan">','<span class="start-time">{@startTime}</span>',"</div>",'<div class="sub-content" data-index={@data-index}>','<textarea data-index="{@data-index}" name="" cols="30" rows="10" placeholder="edit...">{@content}</textarea>','<div class="txt">{@content}</div>',"</div>",'<div class="subspan">','<span class="js_wps">{@wps}</span>','<span class="js_alltime">{@alltime}seconds</span>','<span class="js_wordsCount">{@word}word</span>','<span class="delete-icon" data-id={@textId}>——</span>',"</div>","</div>",'<div class="buttomline"></div>',"</li>"].join(""),g=function(b,c,d,f,g){var h=1==g?"POST":"GET",i=e;a.ajax({url:b,data:c,type:h,dataType:"json",success:function(a){console.log("getData success | "+b+" | "+c),d?i[d](a):console.log(a)},error:function(a){console.error("getData error | "+b+" | "+c),f?i[f](a):console.log(a)}})};return e.init=function(b,c){return this.options=b,this.containerId=c,this.container=a(c),this.localKey=this.options.videoId+"_SUBTITLEAXIS",this.remainKey="REMAIN_SUBTITL",this.remainSKey="REMAIN_SUBTITLEAXIS",this.baseLanguage=b.language,this.staicState=!0,this.newSegments=[],this.newSubtitles=[],this.getServerSubTitles(),this},e.getServerSubTitles=function(){if(!LocalStorage.getItem(this.localKey)||this.staicState){var a=({videoId:this.options.videoId,userName:this.options.userName,token:this.options},this.urls.doload);a=a.replace("{@videoId}",this.options.videoId),g(a,{},"downLoadSubTitlesCallBack")}else this.getStaticState()},e.downLoadSubTitlesCallBack=function(a){var b=null;a.result&&a.subtitle&&(b=a.subtitle),this.subtitles=this.dealLoadSubTitle(b),this.initSegments(),this.initDom();var c=this.subtitles.subtitleItems[this.curIndex];this.changePlayerTime(c.startTime,c.endTime),this.addEvent(),this.addKeyDownEvent(),this.startPostInterval()},e.dealLoadSubTitle=function(a){var b={};if(a){b.timeStamp=a.subtitleTimestamp,b.baseLanguage=this.baseLanguage,b.subtitleItems=[],b.segments=[];for(var c=0,d=a.subtitleItems.length;c<d;c++){var e=a.subtitleItems[c],f=0,g=e.data.length,h={},i={};if(h.startTime=e.startTime,h.endTime=e.endTime,i.startTime=e.startTime/1e3,i.endTime=e.endTime/1e3,i.editable=!0,i.id=e.id,i.segmentId=e.id,h.subtitleItemId=e.id,h.isDifficult=3,0===g)h.content="",h.language=this.baseLanguage;else for(;f<g;f++)e.data[f].language!==this.baseLanguage||(h.content=e.data[f].content,h.explanation=e.data[f].explanation,h.language=e.data[f].language,h.updateTime=e.data[f].updateTime,h.username=e.data[f].username,h.userNickname=e.data[f].userNickname);b.subtitleItems.push(h),b.segments.push(i)}}else b.timeStamp=Math.ceil((new Date).getTime()/1e3),b.baseLanguage=this.baseLanguage,b.subtitleItems=[],b.segments=[];return b},e.getStaticState=function(){var a={videoId:this.options.videoId,userName:this.options.userName,token:this.options};g(this.urls.getState,a,"staticStateCallBack")},e.staticStateCallBack=function(a,b){"error"===b||(a.result&&!a.result.result?this.options.errorCallBack?this.options.errorCallBack("登陆凭证过期，请重新登陆"):this.showNote("字幕静态化数据获取失败"):(this.staicState=a.subtitleResult,this.getServerSubTitles()))},e.mergeLocalItems=function(a){},e.initSegments=function(){window.globalSegments={},window.orderedSegments=[];var a={container:document.getElementById("peaks-container"),mediaElement:document.querySelector("video"),dataUri:{arraybuffer:"http://cdn.yxgapp.com/wave_map_file/"+this.options.videoId+".dat",json:"http://cdn.yxgapp.com/wave_map_file/"+this.options.videoId+".json"},keyboard:!1,height:150,overviewHighlightRectangleColor:"red",zoomWaveformColor:"rgba(0, 225, 128, 1)",overviewWaveformColor:"#F7F3F3",playheadColor:"rgba(0, 0, 0, 1)",axisGridlineColor:"#ccc",axisLabelColor:"#aaa",zoomLevels:[512,1024,2048,4096],pointMarkerColor:"red",segments:this.subtitles.segments,outMarkerColor:"red"};this.peaksInstance=b.init(a),this.peaksInstance.zoom.zoomOut();var d=e;this.peaksInstance.on("segments.dragged",function(a){console.log("-------"+a),c.draggSegment(d.peaksInstance,a)}),this.peaksInstance.on("dbclickAddSegment",function(){c.addSegment(d.peaksInstance)})},e.initDom=function(){this.curIndex=0;var b=this.subtitles.subtitleItems,c=0,d=b.length;for(this.liList=[],this.ulDom=a(0===this.container.find("ul").length?document.createElement("ul"):this.container.find("ul")[0]),this.ulDom.css({positon:"relative",top:0,left:0});c<d;c++){var e=b[c],g=((e.endTime-e.startTime)/1e3).toFixed(1),h=c===this.curIndex?"active":"",i=e.content?e.content:"",j=Math.ceil(i.length/g)+"WPS",k=f.replace("{@startTime}",this.getTimeModel(Math.ceil(e.startTime/1e3))).replace("{@alltime}",g).replace("{@textId}",e.subtitleItemId).replace("{@textId}",e.subtitleItemId).replace("{@textId}",e.subtitleItemId).replace("{@wps}",j).replace("{@word}",i.length).replace("{@class}",h).replace("{@content}",i).replace("{@content}",i).replace("{@data-index}",c).replace("{@data-index}",c).replace("{@data-index}",c);a(this.ulDom).append(k)}this.container.html(this.ulDom),this.lis=a(this.container).find("li"),this.container.mCustomScrollbar({theme:"my-theme",mouseWheel:{scrollAmount:131}})},e.addLiDom=function(b,c){var d=((c.endTime-c.startTime)/1e3).toFixed(1),e=Math.ceil(c.content.length/d)+"WPS",g="active",h=f.replace("{@startTime}",this.getTimeModel(Math.ceil(c.startTime/1e3))).replace("{@alltime}",d).replace("{@textId}",c.subtitleItemId).replace("{@textId}",c.subtitleItemId).replace("{@textId}",c.subtitleItemId).replace("{@wps}",e).replace("{@word}",0).replace("{@class}",g).replace("{@content}",c.content).replace("{@content}",c.content).replace("{@data-index}",b).replace("{@data-index}",b).replace("{@data-index}",b),i=a(h);if(console.log(i),b>0){var j=a(this.lis[b-1]);i.insertAfter(j)}else if(0===b){var k=a(this.lis[b]);i.insertBefore(k)}this.lis=a(this.container).find("li"),this.updateDomIndex(),this.changeCurrentIndex(null,b)},e.deleteLiDom=function(b,c){var d=a("#"+b);d.remove(),this.lis.splice(c,1),this.curIndex>c&&this.curIndex--,this.lis=a(this.container).find("li"),this.updateDomIndex()},e.getTimeModel=function(a){var b=a>1e3?parseInt(a/1e3):a,c=parseInt(b/60),d=parseInt(c/60);return c=c>9?c:"0"+c,b%=60,_secondStr=b>9?b:"0"+b,d>0?d+":"+c+":"+_secondStr:c+":"+_secondStr},e.updateDomIndex=function(b){for(var c=0,d=this.lis.length;c<d;c++)a(this.lis[c]).attr("data-index",c),a(this.lis[c]).find(".sub-content").attr("data-index",c),a(this.lis[c]).find("textarea").attr("data-index",c)},e.updateLoacal=function(a){switch(a){case 1:LocalStorage.setItem(this.localKey,JSON.stringify(this.subtitles));break;case 2:var b=LocalStorage.getItem(this.remainKey)?JSON.parse(LocalStorage.getItem(this.remainKey)):[];this.newSubtitles=this.newSubtitles.concat(b),LocalStorage.setItem(this.remainKey,JSON.stringify(this.newSubtitles)),this.newSubtitles=[];break;case 3:var c=LocalStorage.getItem(this.remainSKey)?JSON.parse(LocalStorage.getItem(this.remainSKey)):[];this.newSegments=this.newSegments.concat(c),LocalStorage.setItem(this.remainSKey,JSON.stringify(this.newSegments)),this.newSegments=[]}},e.clearLocal=function(a){switch(a){case 1:LocalStorage.setItem(this.localKey,"");break;case 2:LocalStorage.setItem(this.remainKey,"");break;case 3:LocalStorage.setItem(this.remainSKey,"")}},e.addEvent=function(){var b=this;this.container.delegate(".sub-content","click",function(c){b.subconClick(a(this),c)}),this.container.delegate("textarea","blur",function(c){return b.enBlur(a(this),c),!1}),this.container.delegate(".delete-icon","click",function(c){var d=a(this).attr("data-id"),e=a(this).parent().prev().attr("data-index");b.showDeleteNote(d,parseInt(e),2)}),a("#js_ok").on("click",function(){var c=a("#js_delete"),d=c.attr("data-id"),e=parseInt(c.attr("data-index"));b.deleteSubtitleById(d,e),c.attr("data-index",""),c.attr("data-id",""),c.hide(),a("#js_mask").hide()}),a("#js_cancel").on("click",function(){var b=a("#js_delete");b.attr("data-index",""),b.attr("data-id",""),b.hide(),a("#js_mask").hide()})},e.addKeyDownEvent=function(){var a=this;document.onkeydown=function(b){var c=b||window.event||arguments.callee.caller.arguments[0];if(console.log("e.ctrlKey:"+c.ctrlKey+"  e.shiftKey:"+c.shiftKey+" keycode:"+c.keyCode),c.shiftKey&&9==c.keyCode);else if(c&&9==c.keyCode);else if(c.ctrlKey){var d=c.keyCode;switch(d){case 65:a.addSubtitleAxis();break;case 82:a.playCurrent();break;case 68:a.deleteSubtitleByCurrentTime();break;case 83:a.pauseVideo()}}}},e.subconClick=function(a,b){var c=parseInt(a.attr("data-index"));this.changeCurrentIndex(null,c),a.find("textarea").show(),a.find(".txt").hide()},e.enBlur=function(a,b){this.edit=!1,this.editType=null,val=a.val(),a.hide();var c=a.siblings(".txt");c.html(val).show();var d=parseInt(a.attr("data-index")),e=this.subtitles.subtitleItems[d];e.content!==val&&""!==val&&(e.content=val,e.updateTime=parseInt((new Date).getTime()/1e3),e.username=this.options.username,e.userNickname=this.options.nickname,e.isDifficult=3,e.action=0,this.newSubtitles.push(e),this.updateLoacal(),this.updateWps(a.parent(),d))},e.updateWps=function(b,c){var d=this.subtitles.subtitleItems[c],e=((d.endTime-d.startTime)/1e3).toFixed(1),f=Math.ceil(d.content.length/e)+"WPS",g=a(b).next();g.find(".js_wps").html(f),g.find(".js_wordsCount").html(d.content.length+"word")},e.showDeleteNote=function(b,c,d){var e=a("#js_delete"),f=this.subtitles.segments[c],g=1==d?"时间轴":"字幕";e.find(".layui-layer-content").html("确定要删除开始时间为："+this.getTimeModel(Math.ceil(f.startTime))+"的"+g+"?"),e.show(),e.attr("data-index",c),e.attr("data-id",b),a("#js_mask").show()},e.deleteSubtitleById=function(a,b){c.deleteSegment(this.peaksInstance,a),this.removeSubtitle(b)},e.findCurrentIndexByCurrentTime=function(){for(var a=this.peaksInstance.time.getCurrentTime(),b=0,c=this.subtitles.segments.length,d=null,e=-1;b<c;b++)if(a>this.subtitles.segments[b].startTime&&a<this.subtitles.segments[b].endTime){d=this.subtitles.segments[b],e=b;break}return e},e.deleteSubtitleByCurrentTime=function(){var a=this.findCurrentIndexByCurrentTime();if(a>=0){var b=this.subtitles.segments[a].segmentId;this.showDeleteNote(b,a,1)}},e.addSubtitleAxis=function(){c.addSegment(this.peaksInstance)},e.addSubtitle=function(){for(var a=0,b=this.subtitles.segments.length,c=orderedSegments,d=-1;a<b;a++)if(this.subtitles.segments[a].id!=c[a].segmentId){d=a;break}d===-1&&(d=c.length-1);var e={};e.id=c[d].segmentId,e.action=1,e.startTime=(1e3*c[d].startTime).toFixed(0),e.endTime=(1e3*c[d].endTime).toFixed(0),console.log(e),this.subtitles.segments.splice(d,0,c[d]),this.newSegments.push(e);var f={content:"",endTime:e.endTime,explanation:null,subtitleItemId:e.id,isDifficult:3,language:this.baseLanguage,startTime:e.startTime,updateTime:(new Date).getTime(),userName:this.options.userName,userNickname:this.options.userNickname};this.subtitles.subtitleItems.splice(d,0,f),this.addLiDom(d,f),this.updateLoacal(1)},e.removeSubtitle=function(a){var b=(this.subtitles.subtitleItems.splice(a,1)[0],this.subtitles.segments.splice(a,1)[0]);b.action=3,b.startTime=1e3*b.startTime,b.endTime=1e3*b.endTime,this.newSegments.push(b),this.deleteLiDom(b.segmentId,a),this.updateLoacal(1)},e.updateSubtitle=function(b){var c=a("#"+b.segmentId),d=parseInt(c.attr("data-index")),e=this.subtitles.segments[d];if(!(Math.abs(1e3*b.startTime-e.startTime<500)&&Math.abs(1e3*b.endTime-e.endTime)<500)){var f={};_newSubtitle=this.subtitles.subtitleItems[d],this.subtitles.segments[d].startTime=b.startTime,this.subtitles.segments[d].endTime=b.endTime,f.startTime=_newSubtitle.startTime=(1e3*b.startTime).toFixed(0),f.endTime=_newSubtitle.endTime=(1e3*b.endTime).toFixed(0),f.id=this.subtitles.segments[d].id;var g=this.findUpdateItem(2,f);g<0&&(f.action=2,this.newSegments.push(f)),c.find(".start-time").html(this.getTimeModel(Math.ceil(f.startTime/1e3)));var h=((f.endTime-f.startTime)/1e3).toFixed(1);c.find(".js_alltime").html(h+"seconds");var i=this.subtitles.subtitleItems[d].content||"",j=Math.ceil(i.length/h)+"WPS";c.find(".js_wps").html(j),this.updateLoacal()}},e.findUpdateItem=function(a,b){var c,d,e;1==a?(c=this.newSubtitles,e="subtitleItemId"):(c=this.newSegments,e="id");for(var d=b[e],f=c.length-1;f>-1;f--)if(d==c[f][e])return f;return-1},e.scrollTo=function(a){var b=0===a?0:150*(a-1);this.container.mCustomScrollbar("scrollTo",b)},e.changeCurrentIndex=function(b,c){if(this.curIndex>=0){var d=a(this.lis[this.curIndex]);d.removeClass("active"),d.find("textarea").hide(),d.find(".txt").show()}b?(a(b).addClass("active"),this.curIndex=parseInt(a(b).attr("data-index"))):c&&(a(this.lis[c]).addClass("active"),this.curIndex=c);var e=this.subtitles.subtitleItems[this.curIndex];this.changePlayerTime(e.startTime/1e3,e.endTime/1e3),this.peaksInstance.time.setCurrentTime(e.startTime/1e3),this.scrollTo(this.curIndex)},e.startPostInterval=function(){var a=this,b=LocalStorage.getItem(this.remainKey)?JSON.parse(LocalStorage.getItem(this.remainKey)):[],c=LocalStorage.getItem(this.remainSKey)?JSON.parse(LocalStorage.getItem(this.remainSKey)):[];if(b=b.concat(this.newSubtitles),b.length>0){console.log("字幕数据有更新|||||有更新数据，提交"+b.length);var d={token:a.options.token,username:a.options.username,videoId:a.options.videoId,from:3,newSubtitle:JSON.stringify(b)};this.updateLoacal(2),g("http://m.yxgapp.com/d/mooc/UpdateSubtitle.json",d,"sendSubtitleSuccessBack","sendSubtitleErrorBack","POST")}else console.log("字幕数据没有更新");if(c=c.concat(this.newSegments),c.length>0){console.log("时间轴数据有更新|||||有更新数据，提交"+c.length);var d={token:a.options.token,username:a.options.username,videoId:a.options.videoId,from:3,subtitleAxises:JSON.stringify(this.newSegments)};this.updateLoacal(3),g("http://m.yxgapp.com/d/mooc/UpdateSubtitleAxis.json",d,"sendSubtitleSuccessBack","sendSubtitleErrorBack","POST")}else console.log("时间轴数据没有更新")},e.sendSubtitleSuccessBack=function(a){console.log("subtitle success"),a.result.resule&&this.clearLocal(2),console.log(a)},e.sendSubtitleErrorBack=function(a){console.error(a)},e.sendAxisSuccessBack=function(a){console.log("Axis-success"),console.log(a),a.result.result&&this.clearLocal(3)},e.sendAxisErrorBack=function(a){},e.saveSegments=function(a,b){},e.changePlayerTime=function(a,b){Control.course.changePlayerTime(a,null)},e.playCurrent=function(){var a=this.findCurrentIndexByCurrentTime();if(this.curSIndex=a,a>=0){var b=this.subtitles.segments[a].startTime;this.peaksInstance.time.setCurrentTime(b),Control.course.player.play(),this.changeCurrentIndex(null,a)}},e.pauseVideo=function(){Control.course.player.pause()},e});